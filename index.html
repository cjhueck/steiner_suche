<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suche</title>
  <link rel="stylesheet" href="publish.css">
  <style>
    html, body { margin:0; padding:0; background: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Ubuntu, sans-serif; line-height: 1.5; color: var(--text-normal, #111); }
    .wrap { max-width: 80%; margin: 0 auto; padding: 0 0 1rem 0; }
    .row { margin: 10px 0; }
    input[type="text"] {
      width: 100%; padding: 10px 12px; box-sizing: border-box;
      border: 1px solid var(--background-modifier-border, #ddd);
      border-radius: 8px; background: transparent;
      color: var(--text-normal, #111);
    }
    .radios { display: flex; align-items: center; gap: 14px; white-space: nowrap; overflow: auto; }
    .radios strong { margin-right: 8px; color: var(--text-muted, #555); font-weight: 500; }
    label { color: var(--text-muted, #555); }
    button {
      padding: 8px 12px; border-radius: 8px; border: 1px solid #467886;
      background: transparent; cursor: pointer; color: #467886;
    }
    button:hover { background: transparent; }
    /* Links + Bullets in #467886 */
    a { color: #467886; text-decoration: none; }
    a:hover { text-decoration: underline; }
    li::marker { color: #467886; }
    .muted { color: var(--text-muted, #555); font-size: .9em; }
    .warn { color: #b35a00; }
    ul { padding-left: 1.2em; margin: .5rem 0 0 0; }
    li { margin: 6px 0; }
    hr { border: none; border-top: 1px solid var(--background-modifier-border, #ddd); margin: 12px 0; }
    .hint { font-size:.9em; color: var(--text-muted, #555); margin-top:.5rem; }
    .disabled { opacity: .7; pointer-events: none; }
    
    /* Styling für Suchergebnisse wie in der lokalen Version */
    .results-header h1 { 
      font-size: 1.125em; 
      font-weight: 600; 
      margin: 1em 0 0.75em 0; 
      color: var(--text-normal, #111); 
    }
    .results-meta { 
      margin-bottom: 1em; 
      color: var(--text-muted, #555); 
    }
    .results-meta strong { 
      font-weight: 600; 
      color: var(--text-normal, #111); 
    }
    .results-list { 
      list-style-type: disc; 
      padding-left: 1.2em; 
    }
    .results-list > li { 
      margin: 0.5em 0; 
      line-height: 1.4; 
    }
    .results-list .sub-headings { 
      list-style-type: none; 
      padding-left: 1em; 
      margin: 0.25em 0; 
    }
    .results-list .sub-headings li { 
      margin: 0.2em 0; 
      position: relative; 
    }
    .results-list .sub-headings li:before { 
      content: "−"; 
      position: absolute; 
      left: -1em; 
      color: #467886; 
    }
  
    .radios input[type="radio"]:checked + label,
    label input[type="radio"]:checked {
      accent-color: #467886;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <input id="term1" type="text" placeholder="Stichwort 1 (z. B. Erkenntnistheorie)">
  </div>
  <div class="row">
    <input id="term2" type="text" placeholder="Stichwort 2 (optional; UND-Verknüpfung)">
  </div>
  <div class="row radios">
    <strong>Suchbereich:</strong>
    <label><input type="radio" name="scope" value="title" checked> Titel</label>
    <label><input type="radio" name="scope" value="subheading"> Abschnitte</label>
    <label><input type="radio" name="scope" value="both"> Beides</label>
    <label><input type="radio" name="scope" value="fulltext"> Gesamter Text</label>
  </div>
  <div class="row">
    <button id="run">Suche starten</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="note" class="row muted"></div>
  <hr>
  <div id="results"></div>
  <div id="frame-note" class="hint" style="display:none;">
    Hinweis: Diese Ansicht ist eingebettet (z. B. in Obsidian). 
    Link-Öffnung ist hier absichtlich deaktiviert. Bitte nutze die Suche direkt: 
    <a href="https://cjhueck.github.io/steiner_suche/" target="_blank">cjhueck.github.io/steiner_suche</a>
  </div>
</div>

<script>
(async function(){
  const BASE_URL = "https://publish.obsidian.md/steiner-ga/";
  const $ = (s)=>document.querySelector(s);
  const resultsEl = $("#results");
  const statusEl = $("#status");
  const noteEl = $("#note");
  const frameNote = $("#frame-note");

  const embedded = (window.top !== window.self);

  // Index laden
  let index;
  try {
    const res = await fetch("./publish-search-index.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Index nicht gefunden");
    index = await res.json();
    statusEl.textContent = "Index geladen: " + (index.items?.length || 0) + " Vorträge";
  } catch(e) {
    resultsEl.innerHTML = '<p class="warn">Konnte <code>publish-search-index.json</code> nicht laden. Lege HTML & JSON in denselben Ordner.</p>';
    console.error(e);
    return;
  }

  if (embedded) {
    frameNote.style.display = '';
  }

  // Check for fulltext support and show warning if missing
  const sample = (index.items||[])[0] || {};
  if (typeof sample.body === "undefined") {
    noteEl.innerHTML = '<span class="warn">Hinweis: Für "Gesamter Text" bitte den Index mit der neuen Exporter-Version (v1.1.0) neu erzeugen.</span>';
  }

  const ensureSlash = (s) => s.endsWith('/') ? s : s + '/';
  const prep = s => (s||"").toLowerCase().trim();
  const includesAny = (h, n) => h.indexOf(n) !== -1;

  function passScope(item, term, scope){
    const t = prep(term);
    if (!t) return true;
    const title = (item.title||'').toLowerCase();
    const headings = (item.headings||[]).map(h => (h||'').toLowerCase());
    const body = (item.body||'').toLowerCase();
    const inTitle = includesAny(title, t);
    const inHeadings = headings.some(h => includesAny(h, t));
    const inBody = body ? includesAny(body, t) : false;
    if (scope === "title") return inTitle;
    if (scope === "subheading") return inHeadings;
    if (scope === "both") return (inTitle || inHeadings);
    if (scope === "fulltext") return (inBody || inTitle || inHeadings);
    return inTitle || inHeadings;
  }

  function toHref(item){
    const raw = (item.path || item.title || '').replace(/\.md$/i, '');
    return ensureSlash(BASE_URL) + encodeURI(raw);
  }

  function getMatchingHeadings(item, term1, term2, scope) {
    if (scope === "title") return [];
    
    const t1 = prep(term1);
    const t2 = prep(term2);
    const headings = item.headings || [];
    const matchedHeadings = [];
    
    for (const heading of headings) {
      const h = prep(heading);
      const match1 = includesAny(h, t1);
      const match2 = !t2 || includesAny(h, t2);
      
      if (match1 && match2) {
        matchedHeadings.push(heading);
      }
    }
    
    return matchedHeadings;
  }

  // VERBESSERT: GA-Nummer und Vortragsnummer aus Titel parsen (mit Suffix-Unterstützung)
  function parseGa(title) {
    // Unterstützt GA068, GA068a, GA068b, GA068c etc.
    const m = /^GA\s*(\d{3}[a-z]?)\s*\(([^)]*)\)/i.exec(title);
    if (!m) return { ga: 9999, lec: 9999, gaSuffix: '' };
    
    const gaFull = m[1]; // z.B. "068c"
    const gaMatch = gaFull.match(/^(\d{3})([a-z]?)$/i);
    const ga = gaMatch ? parseInt(gaMatch[1], 10) : 9999;
    const gaSuffix = gaMatch ? gaMatch[2].toLowerCase() : '';
    
    const lm = m[2].match(/\d+/);
    const lec = lm ? parseInt(lm[0], 10) : 9999;
    
    return { ga, lec, gaSuffix };
  }

  $("#run").addEventListener("click", () => {
    const term1 = prep($("#term1").value);
    const term2 = prep($("#term2").value);
    const scope = (document.querySelector('input[name="scope"]:checked')||{}).value || "title";
    
    if (!term1) {
      resultsEl.innerHTML = "<p>Bitte mindestens ein Stichwort eingeben.</p>";
      return;
    }
    
    const items = (index.items || []);
    const matches = [];
    
    for (const item of items){
      const ok1 = passScope(item, term1, scope);
      const ok2 = !term2 || passScope(item, term2, scope);
      
      if (ok1 && ok2) {
        const matchedHeadings = getMatchingHeadings(item, term1, term2, scope);
        const { ga, lec, gaSuffix } = parseGa(item.title || '');
        matches.push({
          item: item,
          headingHits: matchedHeadings,
          ga: ga,
          lec: lec,
          gaSuffix: gaSuffix
        });
      }
    }
    
    // VERBESSERT: Sortierung nach GA-Nummer, dann Suffix (a,b,c), dann Vortragsnummer, dann Titel
    matches.sort((a, b) => {
      if (a.ga !== b.ga) return a.ga - b.ga;
      if (a.gaSuffix !== b.gaSuffix) return a.gaSuffix.localeCompare(b.gaSuffix);
      if (a.lec !== b.lec) return a.lec - b.lec;
      return (a.item.title || '').localeCompare(b.item.title || '');
    });
    
    // Ergebnisse formatieren wie in der lokalen Version
    const scopeLabels = {
      "title": "Titel",
      "subheading": "Abschnitte", 
      "both": "Beides",
      "fulltext": "Gesamter Text"
    };
    const scopeLabel = scopeLabels[scope] || scope;
    const termsLabel = term2 ? `${$("#term1").value} UND ${$("#term2").value}` : $("#term1").value;
    
    let output = '';
    
    // Header wie in lokaler Version
    output += '<div class="results-header">';
    output += `<h1>Suchergebnisse — ${termsLabel}</h1>`;
    output += '</div>';
    
    // Meta-Info wie in lokaler Version
    output += '<div class="results-meta">';
    output += `Bereich: <strong>${scopeLabel}</strong> • Treffer: <strong>${matches.length}</strong>`;
    output += '</div>';
    
    if (matches.length === 0) {
      output += "<p>Keine passenden Vorträge gefunden.</p>";
    } else {
      output += '<ul class="results-list">';
      
      for (const match of matches) {
        const href = toHref(match.item);
        const cls = embedded ? "disabled" : "";
        const target = embedded ? "" : ' target="steiner_results"';
        
        // Haupteintrag (Datei-Link)
        output += `<li><a class="${cls}" href="${href}"${target}>${match.item.title}</a>`;
        
        // Überschriften-Treffer (falls vorhanden)
        if (match.headingHits && match.headingHits.length > 0 && scope !== "title") {
          output += '<ul class="sub-headings">';
          for (const heading of match.headingHits) {
            const headingHref = href + '#' + encodeURIComponent(heading);
            output += `<li><a class="${cls}" href="${headingHref}"${target}>${heading}</a></li>`;
          }
          output += '</ul>';
        }
        
        output += '</li>';
      }
      
      output += '</ul>';
    }
    
    resultsEl.innerHTML = output;
  });
})();
</script>
</body>
</html>